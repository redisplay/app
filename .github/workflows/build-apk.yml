name: Build APK

on:
  push:
    branches:
      - master
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Set build type
        id: build_type
        run: |
          # Manual trigger: use user input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
          # Tag push: always build release
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            BUILD_TYPE="release"
            echo "Tag detected: ${{ github.ref_name }} - building release"
          # Branch push (e.g., master): always build debug
          else
            BUILD_TYPE="debug"
            echo "Branch push detected: ${{ github.ref }} - building debug"
          fi
          # Capitalize first letter for Gradle task name
          BUILD_TYPE_CAPITALIZED=$(echo "$BUILD_TYPE" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "build_type_capitalized=$BUILD_TYPE_CAPITALIZED" >> $GITHUB_OUTPUT
          echo "Building $BUILD_TYPE APK"
      
      - name: Build APK
        run: ./gradlew assemble${{ steps.build_type.outputs.build_type_capitalized }}
      
      - name: Get version info
        id: version
        run: |
          VERSION_CODE=$(grep -oP 'versionCode \K\d+' app/build.gradle | head -1)
          VERSION_NAME=$(grep -oP 'versionName "\K[^"]+' app/build.gradle | head -1)
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ steps.build_type.outputs.build_type }}-${{ steps.version.outputs.versionCode }}
          path: app/build/outputs/apk/${{ steps.build_type.outputs.build_type }}/*.apk
          retention-days: 90
      
      - name: Get tag name and prepare APK filename
        id: release_info
        run: |
          BUILD_TYPE="${{ steps.build_type.outputs.build_type }}"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag push: use tag name, build release
            TAG_NAME="${{ github.ref_name }}"
            APK_FILENAME="redisplay-release-${{ github.ref_name }}.apk"
            RELEASE_NAME="Release ${{ steps.version.outputs.versionName }} (Build ${{ steps.version.outputs.versionCode }})"
            IS_PRERELEASE="false"
            echo "Release type: Tag release"
          elif [ "$BUILD_TYPE" == "debug" ]; then
            # Master push: debug build
            TAG_NAME="debug-v${{ steps.version.outputs.versionName }}-${{ steps.version.outputs.versionCode }}-${{ github.run_number }}"
            APK_FILENAME="redisplay-debug-${{ github.run_number }}.apk"
            RELEASE_NAME="Debug Build ${{ steps.version.outputs.versionName }} (Build ${{ steps.version.outputs.versionCode }})"
            IS_PRERELEASE="true"
            echo "Release type: Debug build from master"
          else
            # Manual trigger: release build
            TAG_NAME="v${{ steps.version.outputs.versionName }}-${{ steps.version.outputs.versionCode }}-${{ github.run_number }}"
            APK_FILENAME="redisplay-release-${{ steps.version.outputs.versionName }}-${{ steps.version.outputs.versionCode }}.apk"
            RELEASE_NAME="Release ${{ steps.version.outputs.versionName }} (Build ${{ steps.version.outputs.versionCode }})"
            IS_PRERELEASE="false"
            echo "Release type: Manual release"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "apk_filename=$APK_FILENAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
      
      - name: Rename APK for release
        run: |
          mkdir -p release-apk
          cp app/build/outputs/apk/${{ steps.build_type.outputs.build_type }}/*.apk "release-apk/${{ steps.release_info.outputs.apk_filename }}"
          echo "APK renamed to: ${{ steps.release_info.outputs.apk_filename }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          name: ${{ steps.release_info.outputs.release_name }}
          body: |
            ## Version ${{ steps.version.outputs.versionName }}
            
            **Build Type:** ${{ steps.build_type.outputs.build_type }}
            **Version Code:** ${{ steps.version.outputs.versionCode }}
            **Build Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            
            ### Download
            Download the APK from the assets below.
          files: release-apk/${{ steps.release_info.outputs.apk_filename }}
          draft: false
          prerelease: ${{ steps.release_info.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

