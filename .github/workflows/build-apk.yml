name: Build APK

on:
  push:
    branches:
      - master
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Set build type
        id: build_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            BUILD_TYPE="release"
          else
            BUILD_TYPE="debug"
          fi
          # Capitalize first letter for Gradle task name
          BUILD_TYPE_CAPITALIZED=$(echo "$BUILD_TYPE" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "build_type_capitalized=$BUILD_TYPE_CAPITALIZED" >> $GITHUB_OUTPUT
          echo "Building $BUILD_TYPE APK"
      
      - name: Build APK
        run: ./gradlew assemble${{ steps.build_type.outputs.build_type_capitalized }}
      
      - name: Get version info
        id: version
        run: |
          VERSION_CODE=$(grep -oP 'versionCode \K\d+' app/build.gradle | head -1)
          VERSION_NAME=$(grep -oP 'versionName "\K[^"]+' app/build.gradle | head -1)
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ steps.build_type.outputs.build_type }}-${{ steps.version.outputs.versionCode }}
          path: app/build/outputs/apk/${{ steps.build_type.outputs.build_type }}/*.apk
          retention-days: 90
      
      - name: Get tag name
        id: tag
        if: steps.build_type.outputs.build_type == 'release'
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="v${{ steps.version.outputs.versionName }}-${{ steps.version.outputs.versionCode }}-${{ github.run_number }}"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        if: steps.build_type.outputs.build_type == 'release'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.version.outputs.versionName }} (Build ${{ steps.version.outputs.versionCode }})
          body: |
            ## Version ${{ steps.version.outputs.versionName }}
            
            **Version Code:** ${{ steps.version.outputs.versionCode }}
            **Build Number:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            
            ### Download
            Download the APK from the assets below.
          files: app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

